<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUN P2P Data Sharing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1 class="mt-5">GUN P2P Data Sharing with Encryption</h1>
        
        <!-- Import Data Section -->
        <div class="mt-4">
            <h2>Import Data</h2>
            <textarea id="importData" class="form-control" placeholder="Enter JSON data here..."></textarea>
            <button class="btn btn-primary mt-2" onclick="saveData()">Save Data</button>
        </div>
        
        <!-- Shared Data Section -->
        <div class="mt-4">
            <h2>Shared Data</h2>
            <textarea id="sharedData" class="form-control" placeholder="Shared JSON data will appear here..." readonly></textarea>
        </div>
    </div>

    <!-- GUN Library -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <!-- Modal for User Authentication -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">Connect to Shared Data</h5>
                </div>
                <div class="modal-body">
                    <form id="authForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="nodeName" class="form-label">Node Name</label>
                            <input type="text" class="form-control" id="nodeName" placeholder="Enter a unique node name" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="connectToNode()">Connect</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables for GUN and SEA
        let gun;
        let db;
        let user;
        let secretKey;

        // Show the modal on page load
        window.addEventListener('load', () => {
            const authModal = new bootstrap.Modal(document.getElementById('authModal'));
            authModal.show();
        });

        // Initialize GUN with peers
        function connectToNode() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const nodeName = document.getElementById('nodeName').value;

            // Generate a unique secret key using SEA based on username and password
            Gun.SEA.pair().then(pair => {
                secretKey = `${username}:${password}:${nodeName}`;
                initializeGun(nodeName);
            });
        }

        function initializeGun(nodeName) {
            gun = Gun({
                peers: ['https://gun-manhattan.herokuapp.com/gun'] // Peer to connect with
            });
            user = gun.user();

            // Authenticate user and access the node
            user.create(nodeName, secretKey, ack => {
                if (ack.err) {
                    // If user already exists, try logging in
                    user.auth(nodeName, secretKey, loginAck => {
                        if (loginAck.err) {
                            console.error('Login failed:', loginAck.err);
                        } else {
                            setupDatabase(nodeName);
                        }
                    });
                } else {
                    setupDatabase(nodeName);
                }
            });
        }

        function setupDatabase(nodeName) {
            // Connect to the node and decrypt data
            db = user.get(nodeName);

            // Listen for data updates and decrypt before displaying
            db.on(async (data) => {
                if (data) {
                    try {
                        const decryptedData = await Gun.SEA.decrypt(data, secretKey);
                        document.getElementById('sharedData').value = JSON.stringify(decryptedData, null, 2);
                    } catch (error) {
                        console.error('Error decrypting data:', error);
                    }
                }
            });

            // Hide the modal after successful connection
            const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
            authModal.hide();
        }

        async function saveData() {
            try {
                // Get JSON from import textarea
                const newData = JSON.parse(document.getElementById('importData').value);
                newData.timestamp = new Date().toISOString();

                // Encrypt data and store in the database
                const encryptedData = await Gun.SEA.encrypt(newData, secretKey);
                db.put(encryptedData);

                // Clear import textarea
                document.getElementById('importData').value = '';
            } catch (error) {
                alert("Invalid JSON data!");
            }
        }
    </script>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
